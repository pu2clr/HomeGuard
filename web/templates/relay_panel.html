{% extends "base.html" %}

{% block title %}Painel de Relés - HomeGuard{% endblock %}

{% block header %}Controle de Relés{% endblock %}

{% block content %}
<div class="card">
    <h3>Configurações de Visualização</h3>
    <div class="controls">
        <select id="hours-filter">
            <option value="1">Última hora</option>
            <option value="6">Últimas 6 horas</option>
            <option value="24" selected>Últimas 24 horas</option>
            <option value="168">Última semana</option>
        </select>
        
        <input type="number" id="limit-filter" placeholder="Limite de registros" value="100" min="10" max="1000">
        
        <button onclick="loadRelayData()">Atualizar</button>
        
        <label>
            <input type="checkbox" id="auto-refresh" checked> Auto-atualizar (30s)
        </label>
    </div>
</div>

<div class="grid">
    <div class="stat-card">
        <div class="stat-number" id="total-commands">-</div>
        <div class="stat-label">Total de Comandos</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-number" id="unique-relays">-</div>
        <div class="stat-label">Relés Únicos</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-number" id="on-commands">-</div>
        <div class="stat-label">Comandos ON</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-number" id="off-commands">-</div>
        <div class="stat-label">Comandos OFF</div>
    </div>
</div>

<div class="card">
    <h3>Atividade de Relés ao Longo do Tempo</h3>
    <div class="chart-container">
        <canvas id="relayChart"></canvas>
    </div>
</div>

<div class="card">
    <h3>Controle Manual de Relés</h3>
    <div id="relay-controls">
        <div class="loading">Carregando controles...</div>
    </div>
</div>

<div class="card">
    <h3>Análise de Uso</h3>
    <div id="usage-analysis">
        <div class="loading">Analisando padrões de uso...</div>
    </div>
</div>

<div class="card">
    <h3>Histórico de Comandos</h3>
    <div id="relay-history">
        <div class="loading">Carregando histórico...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let relayChart;
let refreshEnabled = true;

async function loadRelayData() {
    const hours = document.getElementById('hours-filter').value;
    const limit = document.getElementById('limit-filter').value;
    
    try {
        // Carregar dados de relés
        const response = await fetch(`/api/relay/data?hours=${hours}&limit=${limit}`);
        const data = await response.json();
        
        // Atualizar estatísticas gerais
        updateGeneralStats(data);
        
        // Atualizar gráfico
        updateRelayChart(data);
        
        // Atualizar controles manuais
        updateRelayControls(data);
        
        // Atualizar análise de uso
        updateUsageAnalysis(data);
        
        // Atualizar histórico
        updateRelayHistory(data);
        
    } catch (error) {
        console.error('Erro ao carregar dados de relé:', error);
        showError('Erro ao carregar dados de relé');
    }
}

function updateGeneralStats(data) {
    const totalCommands = data.length;
    const uniqueRelays = new Set(data.map(item => item.topic)).size;
    
    const onCommands = data.filter(item => 
        item.message && item.message.toLowerCase().includes('on')
    ).length;
    
    const offCommands = data.filter(item => 
        item.message && item.message.toLowerCase().includes('off')
    ).length;
    
    document.getElementById('total-commands').textContent = totalCommands;
    document.getElementById('unique-relays').textContent = uniqueRelays;
    document.getElementById('on-commands').textContent = onCommands;
    document.getElementById('off-commands').textContent = offCommands;
}

function updateRelayChart(data) {
    const ctx = document.getElementById('relayChart').getContext('2d');
    
    if (relayChart) {
        relayChart.destroy();
    }
    
    // Agrupar dados por hora e tipo de comando
    const hourlyData = {};
    data.forEach(item => {
        const date = new Date(item.created_at);
        const hourKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:00`;
        
        if (!hourlyData[hourKey]) {
            hourlyData[hourKey] = { ON: 0, OFF: 0, AUTO: 0, OTHER: 0 };
        }
        
        const message = item.message ? item.message.toUpperCase() : 'OTHER';
        if (message.includes('ON')) {
            hourlyData[hourKey].ON++;
        } else if (message.includes('OFF')) {
            hourlyData[hourKey].OFF++;
        } else if (message.includes('AUTO')) {
            hourlyData[hourKey].AUTO++;
        } else {
            hourlyData[hourKey].OTHER++;
        }
    });
    
    // Preparar datasets
    const commandTypes = ['ON', 'OFF', 'AUTO', 'OTHER'];
    const colors = {
        'ON': '#27ae60',
        'OFF': '#e74c3c',
        'AUTO': '#f39c12',
        'OTHER': '#95a5a6'
    };
    
    const datasets = commandTypes.map(type => ({
        label: `Comandos ${type}`,
        data: Object.entries(hourlyData).map(([hour, commands]) => ({
            x: hour,
            y: commands[type] || 0
        })),
        borderColor: colors[type],
        backgroundColor: colors[type] + '20',
        fill: false,
        tension: 0.4
    }));
    
    relayChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Comandos de Relé por Hora'
                },
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        displayFormats: {
                            hour: 'HH:mm',
                            day: 'dd/MM'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Tempo'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Número de Comandos'
                    },
                    beginAtZero: true
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

function updateRelayControls(data) {
    const container = document.getElementById('relay-controls');
    
    // Obter tópicos únicos de relé
    const relayTopics = [...new Set(data.map(item => item.topic))];
    
    if (relayTopics.length === 0) {
        container.innerHTML = '<p>Nenhum relé encontrado no histórico</p>';
        return;
    }
    
    let html = `
        <div class="grid">
            ${relayTopics.map(topic => {
                const lastCommand = data
                    .filter(item => item.topic === topic)
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
                
                const isOn = lastCommand && lastCommand.message && 
                           lastCommand.message.toLowerCase().includes('on');
                
                return `
                    <div class="card" style="margin: 0;">
                        <h4>${topic}</h4>
                        <p><strong>Estado Atual:</strong> 
                            <span class="${isOn ? 'status-online' : 'status-offline'}">
                                ${isOn ? 'LIGADO' : 'DESLIGADO'}
                            </span>
                        </p>
                        <p><strong>Último Comando:</strong> ${formatDateTime(lastCommand.created_at)}</p>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button onclick="sendRelayCommand('${topic}', 'ON')" 
                                    style="background: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                LIGAR
                            </button>
                            <button onclick="sendRelayCommand('${topic}', 'OFF')" 
                                    style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                DESLIGAR
                            </button>
                            <button onclick="sendRelayCommand('${topic}', 'AUTO')" 
                                    style="background: #f39c12; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                AUTO
                            </button>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
            <h4>Comando Customizado</h4>
            <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                <input type="text" id="custom-topic" placeholder="Tópico (ex: homeguard/relay/1)" 
                       style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="text" id="custom-message" placeholder="Comando (ex: ON)" 
                       style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <button onclick="sendCustomCommand()" 
                        style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                    Enviar
                </button>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function updateUsageAnalysis(data) {
    const container = document.getElementById('usage-analysis');
    
    if (data.length === 0) {
        container.innerHTML = '<p>Sem dados para análise de uso</p>';
        return;
    }
    
    // Análise por relé
    const relayStats = {};
    data.forEach(item => {
        if (!relayStats[item.topic]) {
            relayStats[item.topic] = { ON: 0, OFF: 0, AUTO: 0, OTHER: 0, total: 0 };
        }
        
        const message = item.message ? item.message.toUpperCase() : 'OTHER';
        if (message.includes('ON')) {
            relayStats[item.topic].ON++;
        } else if (message.includes('OFF')) {
            relayStats[item.topic].OFF++;
        } else if (message.includes('AUTO')) {
            relayStats[item.topic].AUTO++;
        } else {
            relayStats[item.topic].OTHER++;
        }
        relayStats[item.topic].total++;
    });
    
    // Análise por período do dia
    const timeAnalysis = analyzeRelayByTime(data);
    
    let html = `
        <div style="margin-bottom: 20px;">
            <h4>Uso por Relé:</h4>
            <table class="table">
                <thead>
                    <tr><th>Relé</th><th>Total</th><th>ON</th><th>OFF</th><th>AUTO</th><th>Outros</th></tr>
                </thead>
                <tbody>
                    ${Object.entries(relayStats).map(([relay, stats]) => `
                        <tr>
                            <td><strong>${relay}</strong></td>
                            <td>${stats.total}</td>
                            <td class="status-online">${stats.ON}</td>
                            <td class="status-offline">${stats.OFF}</td>
                            <td style="color: #f39c12;">${stats.AUTO}</td>
                            <td>${stats.OTHER}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        
        <div>
            <h4>Atividade por Período do Dia:</h4>
            <table class="table">
                <thead>
                    <tr><th>Período</th><th>Comandos</th><th>Percentual</th></tr>
                </thead>
                <tbody>
                    ${timeAnalysis.map(period => `
                        <tr>
                            <td>${period.name}</td>
                            <td>${period.count}</td>
                            <td>${period.percentage.toFixed(1)}%</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

function analyzeRelayByTime(data) {
    const periods = {
        'Madrugada (00-06h)': { count: 0, min: 0, max: 6 },
        'Manhã (06-12h)': { count: 0, min: 6, max: 12 },
        'Tarde (12-18h)': { count: 0, min: 12, max: 18 },
        'Noite (18-24h)': { count: 0, min: 18, max: 24 }
    };
    
    data.forEach(item => {
        const hour = new Date(item.created_at).getHours();
        
        for (const [periodName, period] of Object.entries(periods)) {
            if (hour >= period.min && hour < period.max) {
                period.count++;
                break;
            }
        }
    });
    
    const total = data.length;
    
    return Object.entries(periods).map(([name, period]) => ({
        name,
        count: period.count,
        percentage: total > 0 ? (period.count / total) * 100 : 0
    }));
}

function updateRelayHistory(data) {
    const container = document.getElementById('relay-history');
    
    if (data.length === 0) {
        container.innerHTML = '<p>Nenhum comando de relé encontrado</p>';
        return;
    }
    
    let html = '<table class="table"><thead><tr>';
    html += '<th>Data/Hora</th><th>Tópico</th><th>Comando</th><th>Tempo Decorrido</th></tr></thead><tbody>';
    
    data.forEach(item => {
        const commandTime = new Date(item.created_at);
        const now = new Date();
        const diffMinutes = Math.floor((now - commandTime) / (1000 * 60));
        
        let timeAgo;
        if (diffMinutes < 1) {
            timeAgo = 'Agora mesmo';
        } else if (diffMinutes < 60) {
            timeAgo = `${diffMinutes} min atrás`;
        } else {
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffHours < 24) {
                timeAgo = `${diffHours}h atrás`;
            } else {
                const diffDays = Math.floor(diffHours / 24);
                timeAgo = `${diffDays}d atrás`;
            }
        }
        
        let commandClass = '';
        const message = item.message ? item.message.toUpperCase() : '';
        if (message.includes('ON')) {
            commandClass = 'status-online';
        } else if (message.includes('OFF')) {
            commandClass = 'status-offline';
        } else if (message.includes('AUTO')) {
            commandClass = 'style="color: #f39c12;"';
        }
        
        html += `<tr>
            <td>${formatDateTime(item.created_at)}</td>
            <td><strong>${item.topic}</strong></td>
            <td class="${commandClass}"><strong>${item.message || 'N/A'}</strong></td>
            <td>${timeAgo}</td>
        </tr>`;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

// Funções de controle de relé
async function sendRelayCommand(topic, command) {
    try {
        // Simular envio de comando MQTT
        // Em uma implementação real, você faria uma chamada para sua API MQTT
        console.log(`Enviando comando: ${topic} -> ${command}`);
        
        // Simular resposta
        showSuccessMessage(`Comando enviado: ${command} para ${topic}`);
        
        // Recarregar dados após um pequeno delay
        setTimeout(() => {
            loadRelayData();
        }, 1000);
        
    } catch (error) {
        console.error('Erro ao enviar comando:', error);
        showError('Erro ao enviar comando para o relé');
    }
}

async function sendCustomCommand() {
    const topic = document.getElementById('custom-topic').value.trim();
    const message = document.getElementById('custom-message').value.trim();
    
    if (!topic || !message) {
        showError('Por favor, preencha o tópico e o comando');
        return;
    }
    
    try {
        console.log(`Enviando comando customizado: ${topic} -> ${message}`);
        showSuccessMessage(`Comando customizado enviado: ${message} para ${topic}`);
        
        // Limpar campos
        document.getElementById('custom-topic').value = '';
        document.getElementById('custom-message').value = '';
        
        // Recarregar dados
        setTimeout(() => {
            loadRelayData();
        }, 1000);
        
    } catch (error) {
        console.error('Erro ao enviar comando customizado:', error);
        showError('Erro ao enviar comando customizado');
    }
}

function showSuccessMessage(message) {
    const successDiv = document.createElement('div');
    successDiv.style.cssText = `
        background: #27ae60; color: white; padding: 10px; border-radius: 5px; 
        margin: 10px 0; position: fixed; top: 20px; right: 20px; z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    `;
    successDiv.textContent = message;
    document.body.appendChild(successDiv);
    
    setTimeout(() => {
        successDiv.remove();
    }, 3000);
}

// Event listeners
document.getElementById('hours-filter').addEventListener('change', loadRelayData);
document.getElementById('limit-filter').addEventListener('change', loadRelayData);

document.getElementById('auto-refresh').addEventListener('change', function() {
    refreshEnabled = this.checked;
    if (refreshEnabled) {
        startAutoRefresh(loadRelayData);
    } else {
        stopAutoRefresh();
    }
});

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    loadRelayData();
    
    if (refreshEnabled) {
        startAutoRefresh(loadRelayData);
    }
});

// Parar auto-refresh quando sair da página
window.addEventListener('beforeunload', stopAutoRefresh);
</script>
{% endblock %}
