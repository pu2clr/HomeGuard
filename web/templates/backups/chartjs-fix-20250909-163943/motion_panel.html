{% extends "base.html" %}

{% block title %}Painel de Movimento - HomeGuard{% endblock %}

{% block header %}Monitoramento de Movimento{% endblock %}

{% block content %}
<div class="card">
    <h3>Configurações de Visualização</h3>
    <div class="controls">
        <select id="hours-filter">
            <option value="1">Última hora</option>
            <option value="6">Últimas 6 horas</option>
            <option value="24" selected>Últimas 24 horas</option>
            <option value="168">Última semana</option>
        </select>
        
        <select id="device-filter">
            <option value="">Todos os dispositivos</option>
        </select>
        
        <input type="number" id="limit-filter" placeholder="Limite de registros" value="100" min="10" max="1000">
        
        <button onclick="loadMotionData()">Atualizar</button>
        
        <label>
            <input type="checkbox" id="auto-refresh" checked> Auto-atualizar (30s)
        </label>
    </div>
</div>

<div class="grid">
    <div class="stat-card">
        <div class="stat-number" id="total-detections">-</div>
        <div class="stat-label">Total de Detecções</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-number" id="active-devices">-</div>
        <div class="stat-label">Dispositivos Ativos</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-number" id="avg-detections">-</div>
        <div class="stat-label">Média por Hora</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-number" id="last-detection">-</div>
        <div class="stat-label">Última Detecção</div>
    </div>
</div>

<div class="card">
    <h3>Atividade de Movimento ao Longo do Tempo</h3>
    <div class="chart-container">
        <canvas id="motionChart"></canvas>
    </div>
</div>

<div class="card">
    <h3>Análise de Padrões</h3>
    <div id="pattern-analysis">
        <div class="loading">Analisando padrões de movimento...</div>
    </div>
</div>

<div class="card">
    <h3>Estatísticas por Dispositivo</h3>
    <div id="device-stats">
        <div class="loading">Carregando estatísticas...</div>
    </div>
</div>

<div class="card">
    <h3>Histórico de Detecções</h3>
    <div id="motion-history">
        <div class="loading">Carregando histórico...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let motionChart;
let refreshEnabled = true;

async function loadMotionData() {
    const hours = document.getElementById('hours-filter').value;
    const limit = document.getElementById('limit-filter').value;
    const deviceFilter = document.getElementById('device-filter').value;
    
    try {
        // Carregar dados de movimento
        let url = `/api/motion/data?hours=${hours}&limit=${limit}`;
        const response = await fetch(url);
        const data = await response.json();
        
        // Filtrar por dispositivo se selecionado
        const filteredData = deviceFilter ? 
            data.filter(item => item.device_id === deviceFilter) : data;
        
        // Carregar estatísticas
        await loadMotionStats(hours);
        
        // Atualizar estatísticas gerais
        updateGeneralStats(filteredData, hours);
        
        // Atualizar gráfico
        updateMotionChart(filteredData);
        
        // Atualizar análise de padrões
        updatePatternAnalysis(filteredData);
        
        // Atualizar histórico
        updateMotionHistory(filteredData);
        
        // Atualizar filtro de dispositivos
        updateDeviceFilter(data);
        
    } catch (error) {
        console.error('Erro ao carregar dados de movimento:', error);
        showError('Erro ao carregar dados de movimento');
    }
}

async function loadMotionStats(hours) {
    try {
        const response = await fetch(`/api/motion/stats?hours=${hours}`);
        const stats = await response.json();
        
        if (stats.length === 0) {
            document.getElementById('active-devices').textContent = '0';
            document.getElementById('device-stats').innerHTML = '<p>Nenhum dispositivo ativo</p>';
            return;
        }
        
        document.getElementById('active-devices').textContent = stats.length;
        
        // Atualizar tabela de estatísticas por dispositivo
        updateDeviceStatsTable(stats);
        
    } catch (error) {
        console.error('Erro ao carregar estatísticas:', error);
    }
}

function updateGeneralStats(data, hours) {
    const totalDetections = data.length;
    const avgDetections = (totalDetections / parseInt(hours)).toFixed(1);
    
    document.getElementById('total-detections').textContent = totalDetections;
    document.getElementById('avg-detections').textContent = avgDetections;
    
    if (data.length > 0) {
        const lastDetection = new Date(Math.max(...data.map(item => new Date(item.created_at))));
        const now = new Date();
        const diffMinutes = Math.floor((now - lastDetection) / (1000 * 60));
        
        let lastDetectionText;
        if (diffMinutes < 1) {
            lastDetectionText = 'Agora mesmo';
        } else if (diffMinutes < 60) {
            lastDetectionText = `${diffMinutes}min atrás`;
        } else {
            const diffHours = Math.floor(diffMinutes / 60);
            lastDetectionText = `${diffHours}h atrás`;
        }
        
        document.getElementById('last-detection').textContent = lastDetectionText;
    } else {
        document.getElementById('last-detection').textContent = 'Nenhuma';
    }
}

function updateDeviceStatsTable(stats) {
    const container = document.getElementById('device-stats');
    
    let html = '<table class="table"><thead><tr>';
    html += '<th>Dispositivo</th><th>Local</th><th>Total Detecções</th>';
    html += '<th>Primeira Detecção</th><th>Última Detecção</th><th>Status</th></tr></thead><tbody>';
    
    stats.forEach(device => {
        const statusClass = getStatusClass(device.last_detection);
        html += `<tr>
            <td><strong>${device.device_id}</strong></td>
            <td>${device.location || 'N/A'}</td>
            <td><strong>${device.total_detections}</strong></td>
            <td>${formatDateTime(device.first_detection)}</td>
            <td>${formatDateTime(device.last_detection)}</td>
            <td class="${statusClass}">${statusClass === 'status-online' ? 'Online' : 'Offline'}</td>
        </tr>`;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function updateMotionChart(data) {
    const ctx = document.getElementById('motionChart').getContext('2d');
    
    if (motionChart) {
        motionChart.destroy();
    }
    
    // Agrupar dados por hora
    const hourlyData = {};
    data.forEach(item => {
        const date = new Date(item.created_at);
        const hourKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:00`;
        
        if (!hourlyData[hourKey]) {
            hourlyData[hourKey] = {};
        }
        
        if (!hourlyData[hourKey][item.device_id]) {
            hourlyData[hourKey][item.device_id] = 0;
        }
        
        hourlyData[hourKey][item.device_id]++;
    });
    
    // Obter todos os dispositivos únicos
    const devices = [...new Set(data.map(item => item.device_id))];
    
    // Criar datasets por dispositivo
    const datasets = devices.map(deviceId => ({
        label: deviceId,
        data: Object.entries(hourlyData).map(([hour, deviceData]) => ({
            x: hour,
            y: deviceData[deviceId] || 0
        })),
        borderColor: getDeviceColor(deviceId),
        backgroundColor: getDeviceColor(deviceId, 0.1),
        fill: false,
        tension: 0.4
    }));
    
    motionChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Detecções de Movimento por Hora'
                },
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        displayFormats: {
                            hour: 'HH:mm',
                            day: 'dd/MM'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Tempo'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Número de Detecções'
                    },
                    beginAtZero: true
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

function updatePatternAnalysis(data) {
    const container = document.getElementById('pattern-analysis');
    
    if (data.length === 0) {
        container.innerHTML = '<p>Sem dados para análise de padrões</p>';
        return;
    }
    
    // Análise por período do dia
    const timeAnalysis = analyzeMotionByTime(data);
    
    // Análise por dia da semana
    const dayAnalysis = analyzeMotionByDay(data);
    
    // Análise de frequência
    const frequencyAnalysis = analyzeFrequency(data);
    
    let html = `
        <div class="grid">
            <div class="stat-card">
                <div class="stat-number">${frequencyAnalysis.peakHour}</div>
                <div class="stat-label">Hora de Maior Atividade</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${frequencyAnalysis.peakDay}</div>
                <div class="stat-label">Dia de Maior Atividade</div>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <h4>Atividade por Período do Dia:</h4>
            <table class="table">
                <thead>
                    <tr><th>Período</th><th>Detecções</th><th>Percentual</th></tr>
                </thead>
                <tbody>
                    ${timeAnalysis.map(period => `
                        <tr>
                            <td>${period.name}</td>
                            <td>${period.count}</td>
                            <td>${period.percentage.toFixed(1)}%</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 20px;">
            <h4>Atividade por Dia da Semana:</h4>
            <table class="table">
                <thead>
                    <tr><th>Dia</th><th>Detecções</th><th>Percentual</th></tr>
                </thead>
                <tbody>
                    ${dayAnalysis.map(day => `
                        <tr>
                            <td>${day.name}</td>
                            <td>${day.count}</td>
                            <td>${day.percentage.toFixed(1)}%</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

function analyzeMotionByTime(data) {
    const periods = {
        'Madrugada (00-06h)': { count: 0, min: 0, max: 6 },
        'Manhã (06-12h)': { count: 0, min: 6, max: 12 },
        'Tarde (12-18h)': { count: 0, min: 12, max: 18 },
        'Noite (18-24h)': { count: 0, min: 18, max: 24 }
    };
    
    data.forEach(item => {
        const hour = new Date(item.created_at).getHours();
        
        for (const [periodName, period] of Object.entries(periods)) {
            if (hour >= period.min && hour < period.max) {
                period.count++;
                break;
            }
        }
    });
    
    const total = data.length;
    
    return Object.entries(periods).map(([name, period]) => ({
        name,
        count: period.count,
        percentage: total > 0 ? (period.count / total) * 100 : 0
    }));
}

function analyzeMotionByDay(data) {
    const days = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
    const dayCounts = Array(7).fill(0);
    
    data.forEach(item => {
        const dayOfWeek = new Date(item.created_at).getDay();
        dayCounts[dayOfWeek]++;
    });
    
    const total = data.length;
    
    return days.map((dayName, index) => ({
        name: dayName,
        count: dayCounts[index],
        percentage: total > 0 ? (dayCounts[index] / total) * 100 : 0
    }));
}

function analyzeFrequency(data) {
    // Análise por hora
    const hourCounts = Array(24).fill(0);
    data.forEach(item => {
        const hour = new Date(item.created_at).getHours();
        hourCounts[hour]++;
    });
    
    const peakHourIndex = hourCounts.indexOf(Math.max(...hourCounts));
    const peakHour = `${String(peakHourIndex).padStart(2, '0')}:00`;
    
    // Análise por dia da semana
    const days = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
    const dayCounts = Array(7).fill(0);
    
    data.forEach(item => {
        const dayOfWeek = new Date(item.created_at).getDay();
        dayCounts[dayOfWeek]++;
    });
    
    const peakDayIndex = dayCounts.indexOf(Math.max(...dayCounts));
    const peakDay = days[peakDayIndex];
    
    return { peakHour, peakDay };
}

function updateMotionHistory(data) {
    const container = document.getElementById('motion-history');
    
    if (data.length === 0) {
        container.innerHTML = '<p>Nenhuma detecção de movimento encontrada</p>';
        return;
    }
    
    let html = '<table class="table"><thead><tr>';
    html += '<th>Data/Hora</th><th>Dispositivo</th><th>Local</th><th>Tempo Decorrido</th></tr></thead><tbody>';
    
    data.forEach(item => {
        const detectionTime = new Date(item.created_at);
        const now = new Date();
        const diffMinutes = Math.floor((now - detectionTime) / (1000 * 60));
        
        let timeAgo;
        if (diffMinutes < 1) {
            timeAgo = 'Agora mesmo';
        } else if (diffMinutes < 60) {
            timeAgo = `${diffMinutes} min atrás`;
        } else {
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffHours < 24) {
                timeAgo = `${diffHours}h atrás`;
            } else {
                const diffDays = Math.floor(diffHours / 24);
                timeAgo = `${diffDays}d atrás`;
            }
        }
        
        html += `<tr>
            <td>${formatDateTime(item.created_at)}</td>
            <td><strong>${item.device_id}</strong></td>
            <td>${item.location || 'N/A'}</td>
            <td>${timeAgo}</td>
        </tr>`;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function updateDeviceFilter(data) {
    const select = document.getElementById('device-filter');
    const currentValue = select.value;
    
    // Obter dispositivos únicos
    const devices = [...new Set(data.map(item => item.device_id))];
    
    // Manter apenas a opção "Todos"
    select.innerHTML = '<option value="">Todos os dispositivos</option>';
    
    // Adicionar dispositivos
    devices.forEach(deviceId => {
        const option = document.createElement('option');
        option.value = deviceId;
        option.textContent = deviceId;
        if (deviceId === currentValue) {
            option.selected = true;
        }
        select.appendChild(option);
    });
}

function getDeviceColor(deviceId, alpha = 1) {
    // Gerar cor consistente baseada no ID do dispositivo
    let hash = 0;
    for (let i = 0; i < deviceId.length; i++) {
        hash = deviceId.charCodeAt(i) + ((hash << 5) - hash);
    }
    
    const hue = Math.abs(hash) % 360;
    
    if (alpha < 1) {
        return `hsla(${hue}, 70%, 50%, ${alpha})`;
    } else {
        return `hsl(${hue}, 70%, 50%)`;
    }
}

// Event listeners
document.getElementById('hours-filter').addEventListener('change', loadMotionData);
document.getElementById('device-filter').addEventListener('change', loadMotionData);
document.getElementById('limit-filter').addEventListener('change', loadMotionData);

document.getElementById('auto-refresh').addEventListener('change', function() {
    refreshEnabled = this.checked;
    if (refreshEnabled) {
        startAutoRefresh(loadMotionData);
    } else {
        stopAutoRefresh();
    }
});

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    loadMotionData();
    
    if (refreshEnabled) {
        startAutoRefresh(loadMotionData);
    }
});

// Parar auto-refresh quando sair da página
window.addEventListener('beforeunload', stopAutoRefresh);
</script>
{% endblock %}
