{% extends "base.html" %}

{% block title %}HomeGuard - Eventos{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h2>📋 Eventos Recentes</h2>
    
    <div>
        <select onchange="window.location.href='/events?limit=' + this.value" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
            <option value="25" {% if limit == 25 %}selected{% endif %}>25 eventos</option>
            <option value="50" {% if limit == 50 %}selected{% endif %}>50 eventos</option>
            <option value="100" {% if limit == 100 %}selected{% endif %}>100 eventos</option>
            <option value="200" {% if limit == 200 %}selected{% endif %}>200 eventos</option>
        </select>
        
        <button class="btn" onclick="location.reload()">🔄 Atualizar</button>
    </div>
</div>

{% if events %}
<div class="table">
    <table>
        <thead>
            <tr>
                <th>🕐 Timestamp</th>
                <th>📟 Dispositivo</th>
                <th>⚡ Evento</th>
                <th>📍 Localização</th>
                <th>📶 RSSI</th>
            </tr>
        </thead>
        <tbody>
            {% for event in events %}
            <tr>
                <td>{{ event.timestamp[:19] if event.timestamp else 'N/A' }}</td>
                <td><strong>{{ event.device_id }}</strong></td>
                <td>
                    {% if event.event == 'DETECTED' %}
                        <span style="color: #28a745; font-weight: bold;">🟢 DETECTADO</span>
                    {% elif event.event == 'CLEAR' %}
                        <span style="color: #6c757d; font-weight: bold;">⚪ LIBERADO</span>
                    {% else %}
                        <span style="color: #17a2b8; font-weight: bold;">{{ event.event }}</span>
                    {% endif %}
                </td>
                <td>{{ event.location }}</td>
                <td>
                    {% if event.rssi %}
                        {% if event.rssi > -50 %}
                            <span style="color: #28a745;">📶 {{ event.rssi }} dBm</span>
                        {% elif event.rssi > -70 %}
                            <span style="color: #ffc107;">📶 {{ event.rssi }} dBm</span>
                        {% else %}
                            <span style="color: #dc3545;">📶 {{ event.rssi }} dBm</span>
                        {% endif %}
                    {% else %}
                        <span style="color: #6c757d;">N/A</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div style="margin-top: 2rem;">
    <div class="metrics">
        <div class="metric-card">
            <h3>📊 Total de Eventos</h3>
            <div class="value">{{ events|length }}</div>
        </div>
        
        <div class="metric-card">
            <h3>🟢 Detecções</h3>
            <div class="value">{{ events|selectattr('event', 'equalto', 'DETECTED')|list|length }}</div>
        </div>
        
        <div class="metric-card">
            <h3>⚪ Liberações</h3>
            <div class="value">{{ events|selectattr('event', 'equalto', 'CLEAR')|list|length }}</div>
        </div>
        
        <div class="metric-card">
            <h3>📟 Dispositivos Únicos</h3>
            <div class="value">{{ events|map(attribute='device_id')|unique|list|length }}</div>
        </div>
    </div>
</div>

{% else %}
<div class="alert alert-warning">
    📊 Nenhum evento encontrado no período selecionado.
    <br><br>
    <strong>Possíveis causas:</strong>
    <ul style="margin-top: 0.5rem;">
        <li>Banco de dados vazio</li>
        <li>Monitor MQTT não está rodando</li>
        <li>Sensores não estão enviando dados</li>
    </ul>
    <br>
    <a href="/" class="btn">📊 Ver Visão Geral</a>
</div>
{% endif %}

<div style="margin-top: 2rem; padding: 1rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <h3>ℹ️ Informações</h3>
    <p><strong>Limite atual:</strong> {{ limit }} eventos</p>
    <p><strong>Ordenação:</strong> Mais recentes primeiro</p>
    <p><strong>Atualização:</strong> Automática a cada 30 segundos</p>
    
    <div style="margin-top: 1rem;">
        <a href="/events?limit=25" class="btn">25 eventos</a>
        <a href="/events?limit=50" class="btn">50 eventos</a>
        <a href="/events?limit=100" class="btn">100 eventos</a>
        <a href="/events?limit=200" class="btn">200 eventos</a>
    </div>
</div>
{% endblock %}
