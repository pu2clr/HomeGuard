#!/bin/bash
#
# Script de ROLLBACK inteligente - Retorna ao estado funcionando anterior
# EXECUTAR NO RASPBERRY PI
#

echo "üîÑ ROLLBACK INTELIGENTE - HomeGuard Dashboard"
echo "============================================="
echo ""
echo "üéØ ESTRAT√âGIA:"
echo "   ‚úÖ Restaurar dashboard.py ao estado original"
echo "   ‚úÖ Remover templates de debug criados"
echo "   ‚úÖ Restaurar base.html sem modifica√ß√µes Chart.js"
echo "   ‚úÖ Manter APENAS a corre√ß√£o m√≠nima do gr√°fico temperatura"
echo ""

# Localizar diret√≥rio HomeGuard
HOMEGUARD_DIR="/home/homeguard/HomeGuard"

if [ ! -d "$HOMEGUARD_DIR" ]; then
    echo "‚ùå Diret√≥rio HomeGuard n√£o encontrado: $HOMEGUARD_DIR"
    echo "   Procurando em outros locais..."
    find /home -name "HomeGuard" -type d 2>/dev/null | head -3
    exit 1
fi

cd "$HOMEGUARD_DIR" || exit 1
echo "üìÇ Trabalhando em: $(pwd)"
echo ""

echo "1Ô∏è‚É£ BACKUP ATUAL (seguran√ßa)"
echo "============================"

# Criar backup dos arquivos atuais
BACKUP_DIR="backup_before_rollback_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"

cp web/dashboard.py "$BACKUP_DIR/" 2>/dev/null || echo "   dashboard.py n√£o encontrado"
cp web/templates/base.html "$BACKUP_DIR/" 2>/dev/null || echo "   base.html n√£o encontrado"
cp -r web/templates/dashboard_*.html "$BACKUP_DIR/" 2>/dev/null || echo "   templates debug n√£o encontrados"

echo "   ‚úÖ Backup criado em: $BACKUP_DIR"

echo ""
echo "2Ô∏è‚É£ REMOVENDO ADI√á√ïES DE DEBUG"
echo "============================="

# Remover templates de debug que adicionamos
rm -f web/templates/dashboard_ultra_basic.html
rm -f web/templates/temperature_debug.html
echo "   ‚úÖ Templates de debug removidos"

# Parar dashboard atual
sudo pkill -f dashboard.py
sleep 2
echo "   ‚úÖ Dashboard parado"

echo ""
echo "3Ô∏è‚É£ RESTAURANDO DASHBOARD.PY ORIGINAL"
echo "==================================="

# Verificar se existe backup git ou vers√£o original
if [ -d ".git" ]; then
    echo "   üîç Verificando vers√µes no Git..."
    
    # Verificar se dashboard.py foi modificado
    git status --porcelain web/dashboard.py 2>/dev/null | head -1
    
    # Restaurar vers√£o do git se poss√≠vel
    git checkout HEAD -- web/dashboard.py 2>/dev/null && echo "   ‚úÖ dashboard.py restaurado do Git" || echo "   ‚ö†Ô∏è Git restoration falhou"
else
    echo "   ‚ö†Ô∏è Sem Git - criando dashboard.py baseado no padr√£o conhecido"
fi

# Se o git restore falhou ou n√£o existe, criar vers√£o padr√£o funcional
if [ ! -f web/dashboard.py ] || [ ! -s web/dashboard.py ]; then
    echo "   üîß Criando dashboard.py padr√£o funcional..."
    
cat > web/dashboard.py << 'EOF'
from flask import Flask, render_template, jsonify, request
import sqlite3
import json
from datetime import datetime, timedelta

app = Flask(__name__)

def get_db_connection():
    """Conecta ao banco de dados SQLite"""
    conn = sqlite3.connect('db/homeguard.db')
    conn.row_factory = sqlite3.Row
    return conn

@app.route('/')
def dashboard():
    """P√°gina principal do dashboard"""
    return render_template('dashboard.html')

@app.route('/temperature')
def temperature_panel():
    """Painel de temperatura"""
    return render_template('temperature_panel.html')

@app.route('/humidity') 
def humidity_panel():
    """Painel de umidade"""
    return render_template('humidity_panel.html')

@app.route('/motion')
def motion_panel():
    """Painel de movimento"""
    return render_template('motion_panel.html')

@app.route('/relay')
def relay_panel():
    """Painel de rel√©s"""
    return render_template('relay_panel.html')

@app.route('/api/temperature/data')
def api_temperature_data():
    """API para dados de temperatura"""
    try:
        hours = request.args.get('hours', 24, type=int)
        
        conn = get_db_connection()
        
        # Buscar dados na view de temperatura
        query = """
        SELECT created_at, device_id, name, location, sensor_type, 
               temperature, unit, rssi, uptime
        FROM vw_temperature_activity 
        WHERE datetime(created_at) >= datetime('now', '-{} hours')
        ORDER BY created_at DESC
        LIMIT 1000
        """.format(hours)
        
        rows = conn.execute(query).fetchall()
        conn.close()
        
        data = []
        for row in rows:
            data.append({
                'timestamp': row['created_at'],
                'device_id': row['device_id'],
                'name': row['name'],
                'location': row['location'],
                'sensor_type': row['sensor_type'],
                'temperature': float(row['temperature']) if row['temperature'] else 0,
                'unit': row['unit'],
                'rssi': row['rssi'],
                'uptime': row['uptime']
            })
        
        return jsonify(data)
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/api/humidity/data')
def api_humidity_data():
    """API para dados de umidade"""
    try:
        hours = request.args.get('hours', 24, type=int)
        
        conn = get_db_connection()
        
        query = """
        SELECT created_at, device_id, name, location, sensor_type, 
               humidity, unit, rssi, uptime
        FROM vw_humidity_activity 
        WHERE datetime(created_at) >= datetime('now', '-{} hours')
        ORDER BY created_at DESC
        LIMIT 1000
        """.format(hours)
        
        rows = conn.execute(query).fetchall()
        conn.close()
        
        data = []
        for row in rows:
            data.append({
                'timestamp': row['created_at'],
                'device_id': row['device_id'],
                'name': row['name'],
                'location': row['location'], 
                'sensor_type': row['sensor_type'],
                'humidity': float(row['humidity']) if row['humidity'] else 0,
                'unit': row['unit'],
                'rssi': row['rssi'],
                'uptime': row['uptime']
            })
        
        return jsonify(data)
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/api/motion/data')
def api_motion_data():
    """API para dados de movimento"""
    try:
        hours = request.args.get('hours', 24, type=int)
        
        conn = get_db_connection()
        
        query = """
        SELECT created_at, device_id, name, location
        FROM vw_motion_activity 
        WHERE datetime(created_at) >= datetime('now', '-{} hours')
        ORDER BY created_at DESC
        LIMIT 1000
        """.format(hours)
        
        rows = conn.execute(query).fetchall()
        conn.close()
        
        data = []
        for row in rows:
            data.append({
                'timestamp': row['created_at'],
                'device_id': row['device_id'],
                'name': row['name'],
                'location': row['location']
            })
        
        return jsonify(data)
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/api/relay/data')
def api_relay_data():
    """API para dados de rel√©s"""
    try:
        hours = request.args.get('hours', 24, type=int)
        
        conn = get_db_connection()
        
        query = """
        SELECT created_at, relay_id, status_brasileiro, message
        FROM vw_relay_activity 
        WHERE datetime(created_at) >= datetime('now', '-{} hours')
        ORDER BY created_at DESC
        LIMIT 1000
        """.format(hours)
        
        rows = conn.execute(query).fetchall()
        conn.close()
        
        data = []
        for row in rows:
            data.append({
                'timestamp': row['created_at'],
                'relay_id': row['relay_id'],
                'status': row['status_brasileiro'],
                'message': row['message']
            })
        
        return jsonify(data)
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
EOF

    echo "   ‚úÖ dashboard.py padr√£o criado"
fi

echo ""
echo "4Ô∏è‚É£ VERIFICANDO BASE.HTML"
echo "========================"

# Verificar se base.html existe e tem Chart.js
if [ -f web/templates/base.html ]; then
    # Verificar se tem Chart.js b√°sico
    if grep -q "chart.min.js" web/templates/base.html; then
        echo "   ‚úÖ base.html com Chart.js encontrado"
        
        # Verificar se tem adaptadores problem√°ticos
        if grep -q "chartjs-adapter" web/templates/base.html; then
            echo "   üîß Removendo adaptadores Chart.js problem√°ticos..."
            
            # Criar vers√£o limpa do base.html
            cp web/templates/base.html web/templates/base.html.backup
            
            # Remover linhas de adaptadores
            sed -i.bak '/chartjs-adapter/d' web/templates/base.html
            echo "   ‚úÖ Adaptadores removidos"
        fi
    else
        echo "   ‚ö†Ô∏è base.html sem Chart.js - pode precisar adicionar"
    fi
else
    echo "   ‚ùå base.html n√£o encontrado!"
fi

echo ""
echo "5Ô∏è‚É£ CORRE√á√ÉO M√çNIMA - APENAS GR√ÅFICO TEMPERATURA"
echo "==============================================="

# Verificar se temperature_panel.html precisa da corre√ß√£o m√≠nima do Chart.js
if [ -f web/templates/temperature_panel.html ]; then
    if grep -q "type: 'time'" web/templates/temperature_panel.html; then
        echo "   üîß Aplicando corre√ß√£o m√≠nima no gr√°fico de temperatura..."
        
        # Backup
        cp web/templates/temperature_panel.html web/templates/temperature_panel.html.backup
        
        # Aplicar APENAS a corre√ß√£o do 'time' ‚Üí 'line'
        sed -i.bak "s/type: 'time'/type: 'line'/g" web/templates/temperature_panel.html
        echo "   ‚úÖ Gr√°fico temperatura corrigido (time ‚Üí line)"
    else
        echo "   ‚úÖ Gr√°fico temperatura j√° correto"
    fi
else
    echo "   ‚ö†Ô∏è temperature_panel.html n√£o encontrado"
fi

echo ""
echo "6Ô∏è‚É£ TESTANDO VIEWS DO BANCO"
echo "=========================="

# Verificar se as views existem e funcionam
DB_PATH="db/homeguard.db"

if [ -f "$DB_PATH" ]; then
    TEMP_VIEW_COUNT=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM vw_temperature_activity;" 2>/dev/null || echo "0")
    HUMIDITY_VIEW_COUNT=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM vw_humidity_activity;" 2>/dev/null || echo "0")
    
    echo "   üå°Ô∏è View temperatura: $TEMP_VIEW_COUNT registros"
    echo "   üíß View umidade: $HUMIDITY_VIEW_COUNT registros"
    
    if [ "$TEMP_VIEW_COUNT" = "0" ] || [ "$HUMIDITY_VIEW_COUNT" = "0" ]; then
        echo ""
        echo "   ‚ö†Ô∏è VIEWS PODEM ESTAR VAZIAS!"
        echo "   üí° Isso pode explicar o problema original"
        echo "   üîß Se continuar sem dados, execute fix_database_views.sh"
    else
        echo "   ‚úÖ Views parecem ter dados"
    fi
else
    echo "   ‚ùå Banco de dados n√£o encontrado: $DB_PATH"
fi

echo ""
echo "7Ô∏è‚É£ REINICIANDO DASHBOARD RESTAURADO"
echo "=================================="

# Iniciar dashboard
python3 web/dashboard.py > dashboard_rollback.log 2>&1 &
DASHBOARD_PID=$!

sleep 3
echo "   ‚úÖ Dashboard reiniciado (PID: $DASHBOARD_PID)"

# Testar se est√° respondendo
sleep 2
HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:5000/" 2>/dev/null || echo "000")

if [ "$HTTP_STATUS" = "200" ]; then
    echo "   ‚úÖ Dashboard respondendo (HTTP $HTTP_STATUS)"
else
    echo "   ‚ùå Dashboard n√£o responde (HTTP $HTTP_STATUS)"
    echo "   üìÑ Verificar logs: tail -f dashboard_rollback.log"
fi

echo ""
echo "8Ô∏è‚É£ TESTE FINAL"
echo "=============="

sleep 3

# Testar APIs b√°sicas
TEMP_API_COUNT=$(curl -s "http://localhost:5000/api/temperature/data?hours=1" | jq '. | length' 2>/dev/null || echo "ERRO")
HUMIDITY_API_COUNT=$(curl -s "http://localhost:5000/api/humidity/data?hours=1" | jq '. | length' 2>/dev/null || echo "ERRO")

echo "   üå°Ô∏è API temperatura: $TEMP_API_COUNT registros"
echo "   üíß API umidade: $HUMIDITY_API_COUNT registros"

echo ""
echo "‚úÖ ROLLBACK CONCLU√çDO!"
echo "====================="
echo ""
echo "üìä ESTADO RESTAURADO:"
echo "   üîÑ dashboard.py: vers√£o original/padr√£o"
echo "   üóëÔ∏è templates debug: removidos"
echo "   üé® base.html: adaptadores Chart.js removidos"
echo "   üå°Ô∏è temperatura: gr√°fico corrigido (time‚Üíline)"
echo ""
echo "üß™ TESTE AGORA:"
echo "   Dashboard: http://$(hostname -I | awk '{print $1}'):5000/"
echo ""
echo "üéØ EXPECTATIVA:"
echo "   ‚úÖ Dashboard principal carrega"
echo "   ‚úÖ Pain√©is Umidade/Movimento/Rel√©s funcionam (como antes)"
echo "   ‚úÖ Gr√°fico Temperatura sem erro Chart.js"
echo "   ‚ö†Ô∏è Se pain√©is sem dados: views do banco precisam corre√ß√£o"
echo ""
echo "üìã PR√ìXIMOS PASSOS:"
echo "   1. Testar dashboard principal"
echo "   2. Testar cada painel individualmente"
echo "   3. Se pain√©is vazios: execute fix_database_views.sh"
echo ""
echo "üíæ Backup em: $BACKUP_DIR"
